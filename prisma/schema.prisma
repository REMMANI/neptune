// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================================
// DEALER MANAGEMENT
// Note: Dealer data comes from external API and is NOT stored locally
// Only track which dealers have customizations
// ==================================

model Dealer {
  id                    String                @id @default(cuid())
  externalDealerId      String                @unique // Reference to external dealer API
  slug                  String                @unique // For routing (e.g., premium-motors)
  subdomain             String?               @unique // Optional subdomain
  customDomain          String?               @unique // Optional custom domain
  isActive              Boolean               @default(true)
  lastSyncAt            DateTime?             // Last time dealer data was synced
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  // Relations
  adminAuth             DealerAuth?
  customizations    Customization[]

  @@map("dealers")
  @@index([slug])
  @@index([subdomain])
  @@index([customDomain])
  @@index([externalDealerId])
}

// ==================================
// AUTHENTICATION
// ==================================

model DealerAuth {
  id                String              @id @default(cuid())
  dealerId      String              @unique
  email             String              @unique
  name              String
  hashedPassword    String
  isActive          Boolean             @default(true)
  lastLoginAt       DateTime?
  resetToken        String?
  resetTokenExpiry  DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  // Relations
  dealer        Dealer    @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  sessions          Session[]

  @@map("dealer_admins")
  @@index([email])
  @@index([dealerId])
  @@index([resetToken])
}

model Session {
  id            String           @id @default(cuid())
  dealerAuthId       String
  token         String           @unique
  expiresAt     DateTime
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Relations
  admin         DealerAuth      @relation(fields: [dealerAuthId], references: [id], onDelete: Cascade)

  @@map("sessions")
  @@index([token])
  @@index([dealerAuthId])
  @@index([expiresAt])
}

// ==================================
// TEMPLATE SYSTEM
// ==================================

model Theme {
  id                    String                @id @default(cuid())
  key                   String                @unique // e.g., "base", "t1", "luxury"
  name                  String                // Display name
  description           String
  previewImage          String                // Preview screenshot URL
  category              ThemeCategory         @default(AUTOMOTIVE)
  isDefault             Boolean               @default(false) // One default theme
  isSystemTheme         Boolean               @default(true)  // System vs user-created

  // Theme configuration
  colors                Json                  // Color palette
  typography            Json                  // Font settings
  spacing               Json                  // Layout spacing
  components            Json                  // Component styles

  // Metadata
  tags      String[] @default([])
  sortOrder             Int                   @default(0)
  isActive              Boolean               @default(true)
  version               String                @default("1.0.0")
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  // Relations
  customizations    Customization[]

  @@map("themes")
  @@index([key])
  @@index([category])
  @@index([isActive])
  @@index([isSystemTheme])
  @@index([sortOrder])
}

// ==================================
// SITE CUSTOMIZATION & BUILDER
// ==================================

model Customization {
  id                    String                @id @default(cuid())
  dealerId          String
  themeId               String                // Base theme to extend

  // Customization data
  customColors          Json?                 // Override theme colors
  customTypography      Json?                 // Override theme typography
  customSpacing         Json?                 // Override theme spacing
  customComponents      Json?                 // Override component styles

  // Content & Layout
  sections              Json                  // Page sections configuration
  content               Json                  // Site content (text, images, etc.)
  navigation            Json                  // Menu structure

  // SEO & Meta
  seoSettings           Json                  // Meta tags, descriptions, etc.

  // Publication workflow
  status                PublicationStatus
  publishedAt           DateTime?

  // Builder state (for drafts)
  builderState          Json?                 // Current builder state for resuming work

  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  // Relations
  dealer            Dealer      @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  theme                 Theme                 @relation(fields: [themeId], references: [id])
  revisions             CustomizationRevision[]

  @@map("customizations")
  @@index([dealerId, status])
  @@unique([dealerId, status]) // Only one draft and one published per site
}

// ==================================
// REVISION HISTORY
// ==================================

model CustomizationRevision {
  id                    String                @id @default(cuid())
  customizationId       String
  version               Int                   // Incremental version number

  // Snapshot of customization at this revision
  snapshot              Json                  // Full customization data
  changesSummary        String?               // Optional description of changes
  createdBy             String?               // Admin who created this revision
  createdAt             DateTime              @default(now())

  // Relations
  customization         Customization     @relation(fields: [customizationId], references: [id], onDelete: Cascade)

  @@map("customization_revisions")
  @@index([customizationId])
  @@unique([customizationId, version])
}

// ==================================
// ENUMS
// ==================================

enum ThemeCategory {
  AUTOMOTIVE
  LUXURY
  MODERN
  CLASSIC
  MINIMAL
  CUSTOM
}

enum PublicationStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}